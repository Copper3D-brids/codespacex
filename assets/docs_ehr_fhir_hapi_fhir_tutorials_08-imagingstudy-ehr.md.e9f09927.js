import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.f9076d03.js";const p=JSON.parse('{"title":"Tutorial - FHIR ImagingStudy with EHR data (Duke University data)","description":"","frontmatter":{},"headers":[],"relativePath":"docs/ehr/fhir/hapi_fhir/tutorials/08-imagingstudy-ehr.md","filePath":"docs/ehr/fhir/hapi_fhir/tutorials/08-imagingstudy-ehr.md","lastUpdated":1702526618000}'),o={name:"docs/ehr/fhir/hapi_fhir/tutorials/08-imagingstudy-ehr.md"},e=[l('<h1 id="tutorial-fhir-imagingstudy-with-ehr-data-duke-university-data" tabindex="-1">Tutorial - FHIR ImagingStudy with EHR data (Duke University data) <a class="header-anchor" href="#tutorial-fhir-imagingstudy-with-ehr-data-duke-university-data" aria-label="Permalink to &quot;Tutorial - FHIR ImagingStudy with EHR data (Duke University data)&quot;">​</a></h1><ul><li><p>Tutorial code on GitHub <a href="https://github.com/Copper3D-brids/hapi-py-fhir-tutorials/blob/main/dukeunidata.py" target="_blank" rel="noreferrer">hapi-py-fhir-tutorials -- dukeunidata.py</a>.</p></li><li><p>Currently, it is a <strong>private</strong> repository, will open source later...</p></li></ul><h2 id="background" tabindex="-1">Background <a class="header-anchor" href="#background" aria-label="Permalink to &quot;Background&quot;">​</a></h2><h3 id="scenario" tabindex="-1">Scenario <a class="header-anchor" href="#scenario" aria-label="Permalink to &quot;Scenario&quot;">​</a></h3><p>Last time we mentioned the volunteer Linman took the breast MRIs at the Akron Hospital.The researcher at BioResearch Institute stored the collected MRI data in SPARC SDS datasets. And also he record some interest data in the below form that he would use to do further research. And our aim is to store these EHR data into FHIR resource.</p><table><thead><tr><th style="text-align:center;">Tumor Characteristics</th><th style="text-align:center;"></th><th style="text-align:center;"></th><th style="text-align:center;"></th><th style="text-align:center;">Mammography Characteristics</th><th style="text-align:center;"></th><th style="text-align:center;"></th><th style="text-align:center;">US features</th></tr></thead><tbody><tr><td style="text-align:center;">Staging(Tumor Size)# [T]</td><td style="text-align:center;">Histologic type</td><td style="text-align:center;">Tumor Location</td><td style="text-align:center;">Position</td><td style="text-align:center;">Age at mammo (days)</td><td style="text-align:center;">Breast Density</td><td style="text-align:center;">Tumor Size (cm)</td><td style="text-align:center;">Tumor Size (cm)</td></tr><tr><td style="text-align:center;">2</td><td style="text-align:center;">1</td><td style="text-align:center;">L</td><td style="text-align:center;">L9</td><td style="text-align:center;">NC</td><td style="text-align:center;">NC</td><td style="text-align:center;">5</td><td style="text-align:center;">3</td></tr></tbody></table><p>This table records the observation data from the Mammography and Ultra Sound images. So when we create FHIR resources for these EHR data we need to think about which MVP resources that we need.</p><p>Obviously, we need Patient resource to record the basic information of patient Linman. Then we also need two ImagingStudy resources for storing Mammography and Ultra Sound Dicom images. Finally, in terms of tumour size, location, position .etc data, we can store them into different Observation resources. And their reference relationship as shown in below graph:</p><p><img src="/codespacex/fhir/01-fhir-resources/07-imagingstudy-ehr.png" alt="sparc imagingstudy dev"></p><p>At this tutorial, we only show how to create Patient, Ultra sound ImagingStudy and tumour size Observation resource. As for others, you can follow by the same logic to create them in your database.</p><h2 id="setup-environment" tabindex="-1">Setup environment <a class="header-anchor" href="#setup-environment" aria-label="Permalink to &quot;Setup environment&quot;">​</a></h2><ul><li>Same to Tutorial 02</li></ul><h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">​</a></h2><h3 id="import-library" tabindex="-1">Import library <a class="header-anchor" href="#import-library" aria-label="Permalink to &quot;Import library&quot;">​</a></h3><p>At the beginning we need to import libraries <code>fhirpy</code> and <code>os</code>.</p><p>Also, we re-use the customise function <code>pprint</code> from Tutorial-02. We&#39;ll use it to display some Observation resource data structures.</p><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> os</span></span>\n<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> fhirpy </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> AsyncFHIRClient</span></span>\n<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> pathlib </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> Path</span></span>\n<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> pydicom</span></span>\n<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> datetime </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> datetime</span></span>\n<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> uuid</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> os</span></span>\n<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> fhirpy </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> AsyncFHIRClient</span></span>\n<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> pathlib </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Path</span></span>\n<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> pydicom</span></span>\n<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> datetime </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> datetime</span></span>\n<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> uuid</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="create-an-instance-of-connection" tabindex="-1">Create an instance of connection <a class="header-anchor" href="#create-an-instance-of-connection" aria-label="Permalink to &quot;Create an instance of connection&quot;">​</a></h3><p>To load data from FHIR server we should instaniate <code>FHIRClient</code> class from <code>fhirpy AsyncFHIRClient</code> method.</p><p>Let&#39;s pass <code>url</code> and <code>authorization</code> arguments from environment.</p><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">client </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> AsyncFHIRClient(</span></span>\n<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FFAB70;">url</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;http://localhost:8080/fhir/&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#FFAB70;">authorization</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;Bearer TOKEN&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    )</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">client </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> AsyncFHIRClient(</span></span>\n<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">url</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;http://localhost:8080/fhir/&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">        </span><span style="color:#E36209;">authorization</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;Bearer TOKEN&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    )</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Now, we are able to operate with FHIR resources using <code>client</code>.</p><h2 id="get-patient-linman-from-fhir-database" tabindex="-1">Get patient &#39;Linman&#39; from FHIR database <a class="header-anchor" href="#get-patient-linman-from-fhir-database" aria-label="Permalink to &quot;Get patient &#39;Linman&#39; from FHIR database&quot;">​</a></h2><p>In the perviours tutorial we&#39;ve already created patient Linman in the FHIR database. so we can get Linman by her name.</p><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> patientsResourceSearchSet </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> client.resources(</span><span style="color:#9ECBFF;">&quot;Patient&quot;</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"><span style="color:#E1E4E8;">    Linman </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> patientsResourceSearchSet.search(</span><span style="color:#FFAB70;">name</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&#39;Linman&#39;</span><span style="color:#E1E4E8;">]).first()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> patientsResourceSearchSet </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> client.resources(</span><span style="color:#032F62;">&quot;Patient&quot;</span><span style="color:#24292E;">)</span></span>\n<span class="line"><span style="color:#24292E;">    Linman </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> patientsResourceSearchSet.search(</span><span style="color:#E36209;">name</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&#39;Linman&#39;</span><span style="color:#24292E;">]).first()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>As a result, the dictionary stucture should looks like below:</p><h2 id="generate-imagingstudy-resource-for-ultra-sound-dicom-images" tabindex="-1">Generate ImagingStudy Resource for Ultra sound Dicom images <a class="header-anchor" href="#generate-imagingstudy-resource-for-ultra-sound-dicom-images" aria-label="Permalink to &quot;Generate ImagingStudy Resource for Ultra sound Dicom images&quot;">​</a></h2><p>The Dicom image metadata header tags you may interested in below tags. As for the information tags you can read <a href="https://dicom.nema.org/medical/dicom/current/output/html/part06.html" target="_blank" rel="noreferrer">DICOM Part 6 Data Dictionary</a>.</p><ul><li><code>(0010, 0010) Patient&#39;s Name</code></li><li><code>(0010, 0020) Patient ID</code></li><li><code>(0010, 0030) Patient&#39;s Birth Date</code></li><li><code>(0010, 0040) Patient&#39;s Sex</code></li><li><code>(0010, 1010) Patient&#39;s Age</code></li></ul><p>As for create the ImagingResource, we also need to know which part of body does Linman take the UltraSound. As mentioned in senario, she took the UltraSound for her left breast. So we need to found the left breast code in <a href="http://snomed.info/sct" target="_blank" rel="noreferrer">SNOMED system</a>:</p><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">&quot;code&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;73056007&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;code&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;73056007&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Then, we can create the ImagingStudy resource for UltraSound Dicom image now</p><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">USImageStudyPath </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;your dicom images&#39; folder path&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">patient </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Linman</span></span>\n<span class="line"><span style="color:#E1E4E8;">code </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;US&#39;</span></span>\n<span class="line"><span style="color:#E1E4E8;">display </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Ultrasound&#39;</span></span>\n<span class="line"><span style="color:#E1E4E8;">bodySite </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;system&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;http://snomed.info/sct&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;code&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;73056007&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;display&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Breast&quot;</span></span>\n<span class="line"><span style="color:#E1E4E8;">            }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">samples </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> item </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> USImageStudyPath.iterdir() </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> item.is_dir())</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">first_sample_path </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">next</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">iter</span><span style="color:#E1E4E8;">(USImageStudyPath.glob(</span><span style="color:#9ECBFF;">&#39;*&#39;</span><span style="color:#E1E4E8;">)))</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">dicom_file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pydicom.dcmread(</span><span style="color:#79B8FF;">next</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">iter</span><span style="color:#E1E4E8;">(first_sample_path.glob(</span><span style="color:#9ECBFF;">&#39;*&#39;</span><span style="color:#E1E4E8;">)), </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">))</span></span>\n<span class="line"><span style="color:#E1E4E8;">study_uid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> dicom_file[(</span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0020</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">000d</span><span style="color:#E1E4E8;">)].value</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">try</span><span style="color:#E1E4E8;">:</span></span>\n<span class="line"><span style="color:#E1E4E8;">    dicom_study_time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> dicom_file[(</span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0008</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0030</span><span style="color:#E1E4E8;">)].value</span></span>\n<span class="line"><span style="color:#E1E4E8;">    started_time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> datetime.strptime(dicom_study_time, </span><span style="color:#9ECBFF;">&quot;%H%M%S.</span><span style="color:#79B8FF;">%f</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">).strftime(</span><span style="color:#9ECBFF;">&quot;%Y-%m-</span><span style="color:#79B8FF;">%d</span><span style="color:#9ECBFF;">T%H:%M:%S&quot;</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"><span style="color:#F97583;">except</span><span style="color:#E1E4E8;">:</span></span>\n<span class="line"><span style="color:#E1E4E8;">    started_time </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> datetime.now().strftime(</span><span style="color:#9ECBFF;">&#39;%Y-%m-</span><span style="color:#79B8FF;">%d</span><span style="color:#9ECBFF;">T%H:%M:%S&#39;</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">try</span><span style="color:#E1E4E8;">:</span></span>\n<span class="line"><span style="color:#E1E4E8;">    numberOfSeries </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">int</span><span style="color:#E1E4E8;">(dicom_file[(</span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0020</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">1206</span><span style="color:#E1E4E8;">)].value)</span></span>\n<span class="line"><span style="color:#F97583;">except</span><span style="color:#E1E4E8;">:</span></span>\n<span class="line"><span style="color:#E1E4E8;">    numberOfSeries </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> item </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> USImageStudyPath.iterdir() </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> item.is_dir())</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">try</span><span style="color:#E1E4E8;">:</span></span>\n<span class="line"><span style="color:#E1E4E8;">    numberOfInstances </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">int</span><span style="color:#E1E4E8;">(dicom_file[(</span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0020</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">1208</span><span style="color:#E1E4E8;">)].value)</span></span>\n<span class="line"><span style="color:#F97583;">except</span><span style="color:#E1E4E8;">:</span></span>\n<span class="line"><span style="color:#E1E4E8;">    numberOfInstances </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> sample </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> USImageStudyPath.iterdir():</span></span>\n<span class="line"><span style="color:#E1E4E8;">        numberOfInstances </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> item </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> sample.iterdir() </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> item.is_file())</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> patient </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>\n<span class="line"><span style="color:#E1E4E8;">    series </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> []</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> sample </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> USImageStudyPath.iterdir():</span></span>\n<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> sample.is_file():</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span></span>\n<span class="line"><span style="color:#E1E4E8;">        instances </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> []</span></span>\n<span class="line"><span style="color:#E1E4E8;">        first_file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">next</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">iter</span><span style="color:#E1E4E8;">(sample.glob(</span><span style="color:#9ECBFF;">&#39;*&#39;</span><span style="color:#E1E4E8;">)), </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"><span style="color:#E1E4E8;">        sample_dicom_file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pydicom.dcmread(first_file)</span></span>\n<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;">:</span></span>\n<span class="line"><span style="color:#E1E4E8;">            numberOfSeriesInstances </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">int</span><span style="color:#E1E4E8;">(sample_dicom_file[(</span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0020</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">1209</span><span style="color:#E1E4E8;">)].value)</span></span>\n<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">except</span><span style="color:#E1E4E8;">:</span></span>\n<span class="line"><span style="color:#E1E4E8;">            numberOfSeriesInstances </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sum</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> item </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> sample.iterdir() </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> item.is_file())</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> item </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> sample.iterdir():</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> item.is_dir():</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">break</span></span>\n<span class="line"><span style="color:#E1E4E8;">            instance_dicom_file </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pydicom.dcmread(item)</span></span>\n<span class="line"><span style="color:#E1E4E8;">            dicom_instance </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;uid&quot;</span><span style="color:#E1E4E8;">: instance_dicom_file[(</span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0008</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0018</span><span style="color:#E1E4E8;">)].value,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;number&quot;</span><span style="color:#E1E4E8;">: instance_dicom_file[(</span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0020</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0013</span><span style="color:#E1E4E8;">)].value,</span></span>\n<span class="line"><span style="color:#E1E4E8;">            }</span></span>\n<span class="line"><span style="color:#E1E4E8;">            instances.append(dicom_instance)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">        series.append({</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;uid&quot;</span><span style="color:#E1E4E8;">: sample_dicom_file[(</span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">0020</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">0x</span><span style="color:#79B8FF;">000e</span><span style="color:#E1E4E8;">)].value,</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;modality&quot;</span><span style="color:#E1E4E8;">: {</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;system&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;http://dicom.nema.org/resources/ontology/DCM&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;code&quot;</span><span style="color:#E1E4E8;">: code,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;display&quot;</span><span style="color:#E1E4E8;">: display</span></span>\n<span class="line"><span style="color:#E1E4E8;">            },</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;bodySite&quot;</span><span style="color:#E1E4E8;">: bodySite,</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;numberOfInstances&quot;</span><span style="color:#E1E4E8;">: numberOfSeriesInstances,</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;instance&quot;</span><span style="color:#E1E4E8;">: instances</span></span>\n<span class="line"><span style="color:#E1E4E8;">        })</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#E1E4E8;">    imagingResource </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> client.resource(</span><span style="color:#9ECBFF;">&#39;ImagingStudy&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#FFAB70;">identifier</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[{</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                            </span><span style="color:#9ECBFF;">&quot;system&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;urn:dicom:uid&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                            </span><span style="color:#9ECBFF;">&quot;value&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;urn:oid:</span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">study_uid</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        },</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                            {</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#9ECBFF;">&quot;use&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;temp&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#9ECBFF;">&quot;system&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;urn:sparc_study:uid&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#9ECBFF;">&quot;value&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;urn:uid:</span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">USImageStudyPath.name </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;-&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> study_uid</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                            },</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                            {</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#9ECBFF;">&quot;use&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;temp&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#9ECBFF;">&quot;system&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;urn:sparc_dataset:uid&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                                </span><span style="color:#9ECBFF;">&quot;value&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;urn:uid:</span><span style="color:#79B8FF;">{str</span><span style="color:#E1E4E8;">(USImageStudyPath.parent.parent.name) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;-&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">str</span><span style="color:#E1E4E8;">(uuid.uuid4())</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                            },</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        ],</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#FFAB70;">status</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;available&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#FFAB70;">subject</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">patient.to_reference(),</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#FFAB70;">started</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">started_time,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#FFAB70;">numberOfSeries</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">numberOfSeries,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#FFAB70;">numberOfInstances</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">numberOfInstances,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        </span><span style="color:#FFAB70;">series</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">series</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                        )</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> imagingResource.save()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">USImageStudyPath </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;your dicom images&#39; folder path&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">patient </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Linman</span></span>\n<span class="line"><span style="color:#24292E;">code </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;US&#39;</span></span>\n<span class="line"><span style="color:#24292E;">display </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Ultrasound&#39;</span></span>\n<span class="line"><span style="color:#24292E;">bodySite </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;system&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;http://snomed.info/sct&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;code&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;73056007&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;display&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Breast&quot;</span></span>\n<span class="line"><span style="color:#24292E;">            }</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">samples </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> item </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> USImageStudyPath.iterdir() </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> item.is_dir())</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">first_sample_path </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">next</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">iter</span><span style="color:#24292E;">(USImageStudyPath.glob(</span><span style="color:#032F62;">&#39;*&#39;</span><span style="color:#24292E;">)))</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">dicom_file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pydicom.dcmread(</span><span style="color:#005CC5;">next</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">iter</span><span style="color:#24292E;">(first_sample_path.glob(</span><span style="color:#032F62;">&#39;*&#39;</span><span style="color:#24292E;">)), </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">))</span></span>\n<span class="line"><span style="color:#24292E;">study_uid </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> dicom_file[(</span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0020</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">000d</span><span style="color:#24292E;">)].value</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">try</span><span style="color:#24292E;">:</span></span>\n<span class="line"><span style="color:#24292E;">    dicom_study_time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> dicom_file[(</span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0008</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0030</span><span style="color:#24292E;">)].value</span></span>\n<span class="line"><span style="color:#24292E;">    started_time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> datetime.strptime(dicom_study_time, </span><span style="color:#032F62;">&quot;%H%M%S.</span><span style="color:#005CC5;">%f</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">).strftime(</span><span style="color:#032F62;">&quot;%Y-%m-</span><span style="color:#005CC5;">%d</span><span style="color:#032F62;">T%H:%M:%S&quot;</span><span style="color:#24292E;">)</span></span>\n<span class="line"><span style="color:#D73A49;">except</span><span style="color:#24292E;">:</span></span>\n<span class="line"><span style="color:#24292E;">    started_time </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> datetime.now().strftime(</span><span style="color:#032F62;">&#39;%Y-%m-</span><span style="color:#005CC5;">%d</span><span style="color:#032F62;">T%H:%M:%S&#39;</span><span style="color:#24292E;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">try</span><span style="color:#24292E;">:</span></span>\n<span class="line"><span style="color:#24292E;">    numberOfSeries </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int</span><span style="color:#24292E;">(dicom_file[(</span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0020</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">1206</span><span style="color:#24292E;">)].value)</span></span>\n<span class="line"><span style="color:#D73A49;">except</span><span style="color:#24292E;">:</span></span>\n<span class="line"><span style="color:#24292E;">    numberOfSeries </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> item </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> USImageStudyPath.iterdir() </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> item.is_dir())</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">try</span><span style="color:#24292E;">:</span></span>\n<span class="line"><span style="color:#24292E;">    numberOfInstances </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int</span><span style="color:#24292E;">(dicom_file[(</span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0020</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">1208</span><span style="color:#24292E;">)].value)</span></span>\n<span class="line"><span style="color:#D73A49;">except</span><span style="color:#24292E;">:</span></span>\n<span class="line"><span style="color:#24292E;">    numberOfInstances </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> sample </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> USImageStudyPath.iterdir():</span></span>\n<span class="line"><span style="color:#24292E;">        numberOfInstances </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> item </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> sample.iterdir() </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> item.is_file())</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> patient </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>\n<span class="line"><span style="color:#24292E;">    series </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> []</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> sample </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> USImageStudyPath.iterdir():</span></span>\n<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> sample.is_file():</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span></span>\n<span class="line"><span style="color:#24292E;">        instances </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> []</span></span>\n<span class="line"><span style="color:#24292E;">        first_file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">next</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">iter</span><span style="color:#24292E;">(sample.glob(</span><span style="color:#032F62;">&#39;*&#39;</span><span style="color:#24292E;">)), </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">)</span></span>\n<span class="line"><span style="color:#24292E;">        sample_dicom_file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pydicom.dcmread(first_file)</span></span>\n<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">try</span><span style="color:#24292E;">:</span></span>\n<span class="line"><span style="color:#24292E;">            numberOfSeriesInstances </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int</span><span style="color:#24292E;">(sample_dicom_file[(</span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0020</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">1209</span><span style="color:#24292E;">)].value)</span></span>\n<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">except</span><span style="color:#24292E;">:</span></span>\n<span class="line"><span style="color:#24292E;">            numberOfSeriesInstances </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sum</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> item </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> sample.iterdir() </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> item.is_file())</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> item </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> sample.iterdir():</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> item.is_dir():</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">break</span></span>\n<span class="line"><span style="color:#24292E;">            instance_dicom_file </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pydicom.dcmread(item)</span></span>\n<span class="line"><span style="color:#24292E;">            dicom_instance </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;uid&quot;</span><span style="color:#24292E;">: instance_dicom_file[(</span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0008</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0018</span><span style="color:#24292E;">)].value,</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;number&quot;</span><span style="color:#24292E;">: instance_dicom_file[(</span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0020</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0013</span><span style="color:#24292E;">)].value,</span></span>\n<span class="line"><span style="color:#24292E;">            }</span></span>\n<span class="line"><span style="color:#24292E;">            instances.append(dicom_instance)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">        series.append({</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;uid&quot;</span><span style="color:#24292E;">: sample_dicom_file[(</span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">0020</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">0x</span><span style="color:#005CC5;">000e</span><span style="color:#24292E;">)].value,</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;modality&quot;</span><span style="color:#24292E;">: {</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;system&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;http://dicom.nema.org/resources/ontology/DCM&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;code&quot;</span><span style="color:#24292E;">: code,</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;display&quot;</span><span style="color:#24292E;">: display</span></span>\n<span class="line"><span style="color:#24292E;">            },</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;bodySite&quot;</span><span style="color:#24292E;">: bodySite,</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;numberOfInstances&quot;</span><span style="color:#24292E;">: numberOfSeriesInstances,</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;instance&quot;</span><span style="color:#24292E;">: instances</span></span>\n<span class="line"><span style="color:#24292E;">        })</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#24292E;">    imagingResource </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> client.resource(</span><span style="color:#032F62;">&#39;ImagingStudy&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#E36209;">identifier</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[{</span></span>\n<span class="line"><span style="color:#24292E;">                                            </span><span style="color:#032F62;">&quot;system&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;urn:dicom:uid&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                                            </span><span style="color:#032F62;">&quot;value&quot;</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;urn:oid:</span><span style="color:#005CC5;">{</span><span style="color:#24292E;">study_uid</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span></span>\n<span class="line"><span style="color:#24292E;">                                        },</span></span>\n<span class="line"><span style="color:#24292E;">                                            {</span></span>\n<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#032F62;">&quot;use&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;temp&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#032F62;">&quot;system&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;urn:sparc_study:uid&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#032F62;">&quot;value&quot;</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;urn:uid:</span><span style="color:#005CC5;">{</span><span style="color:#24292E;">USImageStudyPath.name </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;-&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> study_uid</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span></span>\n<span class="line"><span style="color:#24292E;">                                            },</span></span>\n<span class="line"><span style="color:#24292E;">                                            {</span></span>\n<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#032F62;">&quot;use&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;temp&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#032F62;">&quot;system&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;urn:sparc_dataset:uid&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                                                </span><span style="color:#032F62;">&quot;value&quot;</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;urn:uid:</span><span style="color:#005CC5;">{str</span><span style="color:#24292E;">(USImageStudyPath.parent.parent.name) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;-&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">str</span><span style="color:#24292E;">(uuid.uuid4())</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span></span>\n<span class="line"><span style="color:#24292E;">                                            },</span></span>\n<span class="line"><span style="color:#24292E;">                                        ],</span></span>\n<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#E36209;">status</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;available&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#E36209;">subject</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">patient.to_reference(),</span></span>\n<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#E36209;">started</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">started_time,</span></span>\n<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#E36209;">numberOfSeries</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">numberOfSeries,</span></span>\n<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#E36209;">numberOfInstances</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">numberOfInstances,</span></span>\n<span class="line"><span style="color:#24292E;">                                        </span><span style="color:#E36209;">series</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">series</span></span>\n<span class="line"><span style="color:#24292E;">                                        )</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> imagingResource.save()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br></div></div><p>When we create the ImagingStudy resource, we also need to set the patient Linman reference to this UltraSound ImagingStudy resource.</p><h2 id="create-observation-resources" tabindex="-1">Create Observation Resources <a class="header-anchor" href="#create-observation-resources" aria-label="Permalink to &quot;Create Observation Resources&quot;">​</a></h2><p>The <a href="http://hl7.org/fhir/R4/observation.html" target="_blank" rel="noreferrer">Observation</a> resource records the observation result from the UltraSound images. At this stage, from the table above we can see there is a tumour size result from UltraSound images.</p><p>Let&#39;s create the tumour size Observation resource for UltraSound ImagingStudy resource.</p><p>Remember, when we create the Observation resource, we need to find out the tumour size code under the <a href="http://loinc.org" target="_blank" rel="noreferrer">loinc.org</a>.</p><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">linman </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> getPatient(client)</span></span>\n<span class="line"><span style="color:#E1E4E8;">imagingStudyResourceSearchSet </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> client.resources(</span><span style="color:#9ECBFF;">&#39;ImagingStudy&#39;</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"><span style="color:#E1E4E8;">imagingStudys </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> imagingStudyResourceSearchSet.search(</span><span style="color:#FFAB70;">patient</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">linman.to_reference(), </span><span style="color:#FFAB70;">modality</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;US&quot;</span><span style="color:#E1E4E8;">).fetch_all()</span></span>\n<span class="line"><span style="color:#E1E4E8;">us_imagingstudy </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> imagingStudys[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span>\n<span class="line"><span style="color:#E1E4E8;">us_observation </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> client.resource(</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;Observation&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">status</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;preliminary&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">subject</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">linman.to_reference(),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">focus</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">us_imagingstudy.to_reference(),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">category</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[{</span></span>\n<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;coding&#39;</span><span style="color:#E1E4E8;">: [{</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&#39;system&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;http://terminology.hl7.org/CodeSystem/observation-category&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;code&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;laboratory&quot;</span></span>\n<span class="line"><span style="color:#E1E4E8;">        }]</span></span>\n<span class="line"><span style="color:#E1E4E8;">    }],</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">code</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{</span></span>\n<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">&#39;coding&#39;</span><span style="color:#E1E4E8;">: [{</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&#39;system&#39;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&#39;http://loinc.org&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;code&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;21889-1&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;display&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Size Tumor&quot;</span></span>\n<span class="line"><span style="color:#E1E4E8;">        }]</span></span>\n<span class="line"><span style="color:#E1E4E8;">    },</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">effectiveDateTime</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;2018-04-01T00:00:00Z&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#FFAB70;">component</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[</span></span>\n<span class="line"><span style="color:#E1E4E8;">        {</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;code&quot;</span><span style="color:#E1E4E8;">: {</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;coding&quot;</span><span style="color:#E1E4E8;">: [</span></span>\n<span class="line"><span style="color:#E1E4E8;">                    {</span></span>\n<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&quot;system&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;http://loinc.org&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">&quot;code&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;33728-7&quot;</span></span>\n<span class="line"><span style="color:#E1E4E8;">                    }</span></span>\n<span class="line"><span style="color:#E1E4E8;">                ]</span></span>\n<span class="line"><span style="color:#E1E4E8;">            },</span></span>\n<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;valueQuantity&quot;</span><span style="color:#E1E4E8;">: {</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;value&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">2.5</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;unit&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;centimeters&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;system&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;http://unitsofmeasure.org&quot;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;code&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;cm&quot;</span></span>\n<span class="line"><span style="color:#E1E4E8;">            }</span></span>\n<span class="line"><span style="color:#E1E4E8;">        }</span></span>\n<span class="line"><span style="color:#E1E4E8;">    ]</span></span>\n<span class="line"><span style="color:#E1E4E8;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> us_observation.save()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">linman </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> getPatient(client)</span></span>\n<span class="line"><span style="color:#24292E;">imagingStudyResourceSearchSet </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> client.resources(</span><span style="color:#032F62;">&#39;ImagingStudy&#39;</span><span style="color:#24292E;">)</span></span>\n<span class="line"><span style="color:#24292E;">imagingStudys </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> imagingStudyResourceSearchSet.search(</span><span style="color:#E36209;">patient</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">linman.to_reference(), </span><span style="color:#E36209;">modality</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;US&quot;</span><span style="color:#24292E;">).fetch_all()</span></span>\n<span class="line"><span style="color:#24292E;">us_imagingstudy </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> imagingStudys[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">]</span></span>\n<span class="line"><span style="color:#24292E;">us_observation </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> client.resource(</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;Observation&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">status</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;preliminary&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">subject</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">linman.to_reference(),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">focus</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">us_imagingstudy.to_reference(),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">category</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[{</span></span>\n<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;coding&#39;</span><span style="color:#24292E;">: [{</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&#39;system&#39;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;http://terminology.hl7.org/CodeSystem/observation-category&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;code&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;laboratory&quot;</span></span>\n<span class="line"><span style="color:#24292E;">        }]</span></span>\n<span class="line"><span style="color:#24292E;">    }],</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">code</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">{</span></span>\n<span class="line"><span style="color:#24292E;">        </span><span style="color:#032F62;">&#39;coding&#39;</span><span style="color:#24292E;">: [{</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&#39;system&#39;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&#39;http://loinc.org&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;code&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;21889-1&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;display&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Size Tumor&quot;</span></span>\n<span class="line"><span style="color:#24292E;">        }]</span></span>\n<span class="line"><span style="color:#24292E;">    },</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">effectiveDateTime</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;2018-04-01T00:00:00Z&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#E36209;">component</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span></span>\n<span class="line"><span style="color:#24292E;">        {</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;code&quot;</span><span style="color:#24292E;">: {</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;coding&quot;</span><span style="color:#24292E;">: [</span></span>\n<span class="line"><span style="color:#24292E;">                    {</span></span>\n<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&quot;system&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;http://loinc.org&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                        </span><span style="color:#032F62;">&quot;code&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;33728-7&quot;</span></span>\n<span class="line"><span style="color:#24292E;">                    }</span></span>\n<span class="line"><span style="color:#24292E;">                ]</span></span>\n<span class="line"><span style="color:#24292E;">            },</span></span>\n<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;valueQuantity&quot;</span><span style="color:#24292E;">: {</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;value&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">2.5</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;unit&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;centimeters&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;system&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;http://unitsofmeasure.org&quot;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;code&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;cm&quot;</span></span>\n<span class="line"><span style="color:#24292E;">            }</span></span>\n<span class="line"><span style="color:#24292E;">        }</span></span>\n<span class="line"><span style="color:#24292E;">    ]</span></span>\n<span class="line"><span style="color:#24292E;">)</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">await</span><span style="color:#24292E;"> us_observation.save()</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>After we create the Observation resource for tumour size, we should take the patient Linman and her UltraSound ImagingStudy resources as references into <code>subject</code> and <code>focus</code> fields, respectively.</p><h2 id="search-imagingstudy-resource" tabindex="-1">Search ImagingStudy Resource <a class="header-anchor" href="#search-imagingstudy-resource" aria-label="Permalink to &quot;Search ImagingStudy Resource&quot;">​</a></h2><p>Please view <a href="http://hl7.org/fhir/R4/imagingstudy.html#search" target="_blank" rel="noreferrer">ImagingStudy Search Parameters</a> and <a href="http://hl7.org/fhir/R4/observation.html#search" target="_blank" rel="noreferrer">Observation Search Parameters</a> to find out the parameters for search in you senario.</p><ul><li>Let&#39;s try search all studies/ImagingStudy Resources of a patient/volunteer <code>linman</code> accross all SPARC Datasets. (Find all ImagingStudy Resources related to <code>linman</code>)</li></ul><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">linman </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> getPatient(client)</span></span>\n<span class="line"><span style="color:#E1E4E8;">imagingStudyResourceSearchSet </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> client.resources(</span><span style="color:#9ECBFF;">&#39;ImagingStudy&#39;</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"><span style="color:#6A737D;"># get all imagingStudy of patient linman</span></span>\n<span class="line"><span style="color:#E1E4E8;">imagingStudys </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> imagingStudyResourceSearchSet.search(</span><span style="color:#FFAB70;">patient</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">linman.to_reference()).fetch_all()</span></span>\n<span class="line"><span style="color:#E1E4E8;">get </span><span style="color:#79B8FF;">all</span><span style="color:#E1E4E8;"> ultrasound imageStudy of patient linman</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">linman </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> getPatient(client)</span></span>\n<span class="line"><span style="color:#24292E;">imagingStudyResourceSearchSet </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> client.resources(</span><span style="color:#032F62;">&#39;ImagingStudy&#39;</span><span style="color:#24292E;">)</span></span>\n<span class="line"><span style="color:#6A737D;"># get all imagingStudy of patient linman</span></span>\n<span class="line"><span style="color:#24292E;">imagingStudys </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> imagingStudyResourceSearchSet.search(</span><span style="color:#E36209;">patient</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">linman.to_reference()).fetch_all()</span></span>\n<span class="line"><span style="color:#24292E;">get </span><span style="color:#005CC5;">all</span><span style="color:#24292E;"> ultrasound imageStudy of patient linman</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>Let&#39;s try search the tumour size observation from the UltraSound image</li></ul><div class="language-py vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">imagingStudys </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> imagingStudyResourceSearchSet.search(</span><span style="color:#FFAB70;">patient</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">linman.to_reference(), </span><span style="color:#FFAB70;">modality</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;US&quot;</span><span style="color:#E1E4E8;">).fetch_all()</span></span>\n<span class="line"><span style="color:#6A737D;"># get the linman&#39;s ultrasound observation resource</span></span>\n<span class="line"><span style="color:#E1E4E8;">observation </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">await</span><span style="color:#E1E4E8;"> client.resources(</span><span style="color:#9ECBFF;">&quot;Observation&quot;</span><span style="color:#E1E4E8;">).search(</span><span style="color:#FFAB70;">patient</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">linman.to_reference(),</span></span>\n<span class="line"><span style="color:#E1E4E8;">                                                            </span><span style="color:#FFAB70;">focus</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">imagingStudys[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">].to_reference()).fetch_all()</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(observation)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">imagingStudys </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> imagingStudyResourceSearchSet.search(</span><span style="color:#E36209;">patient</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">linman.to_reference(), </span><span style="color:#E36209;">modality</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;US&quot;</span><span style="color:#24292E;">).fetch_all()</span></span>\n<span class="line"><span style="color:#6A737D;"># get the linman&#39;s ultrasound observation resource</span></span>\n<span class="line"><span style="color:#24292E;">observation </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">await</span><span style="color:#24292E;"> client.resources(</span><span style="color:#032F62;">&quot;Observation&quot;</span><span style="color:#24292E;">).search(</span><span style="color:#E36209;">patient</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">linman.to_reference(),</span></span>\n<span class="line"><span style="color:#24292E;">                                                            </span><span style="color:#E36209;">focus</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">imagingStudys[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">].to_reference()).fetch_all()</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#005CC5;">print</span><span style="color:#24292E;">(observation)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">​</a></h2><p>In this tutorial the following topics were covered:</p><ul><li><code>Patient</code>, <code>ImagingStudy</code> and <code>Observation</code> resources.</li><li>How to use <code>pydicom</code> to get dicom file tags information.</li><li>How to search <code>ImagingStudy Resource</code> for specific identifier and speciality.</li><li>Search specific observation resource via ImagingStudy.</li></ul>',49)];const t=s(o,[["render",function(s,l,p,o,t,r){return n(),a("div",null,e)}]]);export{p as __pageData,t as default};
