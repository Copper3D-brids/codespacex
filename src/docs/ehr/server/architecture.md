# EHR server achitecture based on FHIR

- EHR Data: Hospital, Vunlenteer data.
- FHIR Server: Hapi Fhir
- DATABASE: PostgreSQL
- DICOM Server: Othanc
- Packages: fhirpy, sparc-me, Digitaltwins-api
- Environment: Docker, Python 3.9+

## Initial Architecture Plan

Edit/modify it on [here](https://app.diagrams.net/#G1voInd2Kxwf2Tn9MU8xky5Kpu_ysRJvjt).

![image](/server/architecture-01.png)

### EHR Data Part

![image](/server/architecture-02.png)

### DigitalTWINS Plateform Part

![image](/server/architecture-03.png)

### Basic draft

#### ASCII Basic Layout

- Edit on [here](https://asciiflow.com/#/local/ehr-architecture-local).
- If it is empty, copy and paste below code to `Asciiflow` website.

```sh
     +----------------------------------------------------------------------------------------------------+
     |                                                                                                    |
     |                                     DigitalTWINS platform                                          |
     |                                                                                                    |
     |                                                                                                    |
     |                              +-------------+                                                       |
     |                              | PostgreSQL  |                               +--------------------+  |
     |                              +------+------+                               |                    |  |
     |                                     |                                      |                    |  |
     |                     Imageing  +-----+----+                                 |        Gen 3       |  |
     |         +---------+  Study    |   HAPI   |             +------------+      |                    |  |
     |         | Orthanc +-----------+   FHIR   |             |    OMOP    |      |                    |  |
     |         | Server  |   PACs    |  Server  |             |            |      +--------------------+  |
     |         +---------+           +---^--+---+             |   Server   |                              |
     |                                   |  |                 +------+-----+                              |
     |                                   |  |                        |                                    |
     |                                   |  |Restful API             |                                    |
     |                                   |  |                        |            +--------------------+  |
     |                                   |  |                        |            |                    |  |
     | +---------------------------------+--v------------------------+-------+    |       Other        |  |
     | |                     Backend/DigitalTWIN API                 |       |    |                    |  |
     | |                                                             |       |    |      Server ...    |  |
     | | +-------------+  +-------------+  +-------------+   +-------+-----+ |    |                    |  |
     | | |             |  |             |  |             |   |    OMOP     | |    +--------------------+  |
     | | |   fhiypy    |  |   sparc-me  |  | dgitialtwin |   |   python    | |                            |
     | | |             |  |             |  |     api     |   |   plugin    | |                            |
     | | +-------------+  +-------------+  +-------------+   +-------------+ |                            |
     | |                                                                     |                            |
     | +---------------------------------------------------------------------+                            |
     |                                                                                                    |
     +----------------------------------------------------------------------------------------------------+




 +----------------------------------------------------------------------------------------------------------------+
 |                                           Authentication  Layer                                                |
 +---------------------------------------------------------------------------------------------------------------++
                                                                                  ^                  ^           |
                                                                                  |                  |           |
                                                                                  |                  |           |
                                                                                  |                  |           |
                                                                                  |                  |           |
+----------------------------------------+---------------+------------------------+---------+        |           |
|                                        +---------------+                        |         |        |           |
|                                        |   EHR Data    |                        |         |        |           |
|                                        +---------------+                        |         |        |           |
|                                                                                 |         |        |           |
|                                      +----------+                               |         |        |           |
|                                      | De iden- |  De-identified                |         |        |           |
| +-----------+         +-----------+  | -tify.py |  +-----------+         +------+-------+ |        |           |
| |           | Export  |   FHIR    |  +----------+  |   FHIR    |         |              | |        |           |
| | Hospital  +-------->|  boudle   +--+----------+->|  boudle   +-------->|              | |        |           v
| |           |         | resource  |                | resource  |         |              | |   +----+------------------------+
| +-----------+         +-----------+                +-----------+         |              | |   |                             |
|                                                                          |              | |   |                             |
|                                      +----------+                        |              | |   |       12L Portal APP        |
|                                      |  FHIR    |  De-identified         |      SDS     | |   |                             |
| +-----------+         +-----------+  | mapping  |  +-----------+         |              | |   |              /              |
| |   Study   | Export  |           |  +----------+  |   FHIR    |         |    Dataset   | |   |         Other APPs          |
| |  RedCap   +-------->| Raw Data  +--+----------+->|  boudle   +-------->|              | |   |                             |
| |           |         |           |                | resource  |         |              | |   +-----------------------------+
| +-----------+         +-----------+                +-----------+         |              | |
|                                      +----------+                        |              | |
|                                      | De iden- |  De-identified         |              | |
| +-----------+         +-----------+  | -tify.py |  +-----------+         |              | |
| |  Remote   | Export  |   FHIR    |  +----------+  |   FHIR    |         |              | |
| | monitoring+-------->|  boudle   +--+----------+->|  boudle   +-------->|              | |
| |   data    |         | resource  |                | resource  |         +--------------+ |
| +-----------+         +-----------+                +-----------+                          |
|                                                                                           |
|                                                                                           |
+-------------------------------------------------------------------------------------------+
```

#### ASCII Extended Layout

```sh
     ┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
     │                                                                                                    │
     │                                     DigitalTWINS platform                                          │
     │                                                                                                    │
     │                                                                                                    │
     │                              ┌─────────────┐                                                       │
     │                              │ PostgreSQL  │                               ┌────────────────────┐  │
     │                              └──────┬──────┘                               │                    │  │
     │                                     │                                      │                    │  │
     │                     Imageing  ┌─────┴────┐                                 │        Gen 3       │  │
     │         ┌─────────┐  Study    │   HAPI   │             ┌────────────┐      │                    │  │
     │         │ Orthanc ├───────────┤   FHIR   │             │    OMOP    │      │                    │  │
     │         │ Server  │   PACs    │  Server  │             │            │      └────────────────────┘  │
     │         └─────────┘           └───▲──┬───┘             │   Server   │                              │
     │                                   │  │                 └──────┬─────┘                              │
     │                                   │  │                        │                                    │
     │                                   │  │Restful API             │                                    │
     │                                   │  │                        │            ┌────────────────────┐  │
     │                                   │  │                        │            │                    │  │
     │ ┌─────────────────────────────────┴──▼────────────────────────┼───────┐    │       Other        │  │
     │ │                     Backend/DigitalTWIN API                 │       │    │                    │  │
     │ │                                                             │       │    │      Server ...    │  │
     │ │ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   ┌───────┴─────┐ │    │                    │  │
     │ │ │             │  │             │  │             │   │    OMOP     │ │    └────────────────────┘  │
     │ │ │   fhiypy    │  │   sparc-me  │  │ dgitialtwin │   │   python    │ │                            │
     │ │ │             │  │             │  │     api     │   │   plugin    │ │                            │
     │ │ └─────────────┘  └─────────────┘  └─────────────┘   └─────────────┘ │                            │
     │ │                                                                     │                            │
     │ └─────────────────────────────────────────────────────────────────────┘                            │
     │                                                                                                    │
     └────────────────────────────────────────────────────────────────────────────────────────────────────┘




 ┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
 │                                           Authentication  Layer                                                │
 └───────────────────────────────────────────────────────────────────────────────────────────────────────────────┬┘
                                                                                  ▲                  ▲           │
                                                                                  │                  │           │
                                                                                  │                  │           │
                                                                                  │                  │           │
                                                                                  │                  │           │
┌────────────────────────────────────────┬───────────────┬────────────────────────┼─────────┐        │           │
│                                        ├───────────────┤                        │         │        │           │
│                                        │   EHR Data    │                        │         │        │           │
│                                        └───────────────┘                        │         │        │           │
│                                                                                 │         │        │           │
│                                      ┌──────────┐                               │         │        │           │
│                                      │ De iden- │  De-identified                │         │        │           │
│ ┌───────────┐         ┌───────────┐  │ -tify.py │  ┌───────────┐         ┌──────┴───────┐ │        │           │
│ │           │ Export  │   FHIR    │  ├──────────┤  │   FHIR    │         │              │ │        │           │
│ │ Hospital  ├────────►│  boudle   ├──┴──────────┴─►│  boudle   ├────────►│              │ │        │           ▼
│ │           │         │ resource  │                │ resource  │         │              │ │   ┌────┴────────────────────────┐
│ └───────────┘         └───────────┘                └───────────┘         │              │ │   │                             │
│                                                                          │              │ │   │                             │
│                                      ┌──────────┐                        │              │ │   │       12L Portal APP        │
│                                      │  FHIR    │  De-identified         │      SDS     │ │   │                             │
│ ┌───────────┐         ┌───────────┐  │ mapping  │  ┌───────────┐         │              │ │   │              /              │
│ │   Study   │ Export  │           │  ├──────────┤  │   FHIR    │         │    Dataset   │ │   │         Other APPs          │
│ │  RedCap   ├────────►│ Raw Data  ├──┴──────────┴─►│  boudle   ├────────►│              │ │   │                             │
│ │           │         │           │                │ resource  │         │              │ │   └─────────────────────────────┘
│ └───────────┘         └───────────┘                └───────────┘         │              │ │
│                                      ┌──────────┐                        │              │ │
│                                      │ De iden- │  De-identified         │              │ │
│ ┌───────────┐         ┌───────────┐  │ -tify.py │  ┌───────────┐         │              │ │
│ │  Remote   │ Export  │   FHIR    │  ├──────────┤  │   FHIR    │         │              │ │
│ │ monitoring├────────►│  boudle   ├──┴──────────┴─►│  boudle   ├────────►│              │ │
│ │   data    │         │ resource  │                │ resource  │         └──────────────┘ │
│ └───────────┘         └───────────┘                └───────────┘                          │
│                                                                                           │
│                                                                                           │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```
